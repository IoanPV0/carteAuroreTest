<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Carte des missions Aurore</title>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 500px; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Importer un fichier Excel (.xls)</h2>
  <input type="file" id="upload" accept=".xls" />
  <button onclick="exportCache()">Exporter le cache</button>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([46.5, 2.5], 6); // centre France
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const apiKey = '2164e0e6e2b54796be75d32f6cba57f1';
    const cache = JSON.parse(localStorage.getItem('geoCache') || '{}');

    document.getElementById('upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();

      reader.onload = async function(event) {
        const workbook = XLSX.read(event.target.result, { type: 'binary' });

        // Nettoyer les anciens marqueurs sauf la couche fond de carte
        map.eachLayer(layer => {
          if (!layer._url) map.removeLayer(layer);
        });

        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(sheet);

        const ouvertData = jsonData.filter(row => row.Statut === "Ouvert");
        console.clear();

        for (const row of ouvertData) {
          const adresse = `${row.Adresse}, ${row.CP} ${row.Ville}`;
          const territoire = `${row.Territoire}`;
          const nom = row["Nom de la mission"] || "Inconnu";
          const description = row["Description et objectifs"] || "Aucune description fournie";
          let dateOuverture = row["Date ouverture"];

            if (typeof dateOuverture === 'number') {
                dateOuverture = excelDateToJSDate(dateOuverture);
            }
          try {
            const coords = await getOrGeocode(adresse);
            if (coords) {
              L.marker([coords.lat, coords.lon]).addTo(map)
                .bindPopup(`<strong>${nom}</strong><p>${adresse}</p><p>Territoire : ${territoire}</p><p>Date ouverture : ${dateOuverture}</p><p>Description : ${description}</p>`);
            }
          } catch (err) {
            console.error("Erreur de géocodage:", err);
          }
        }

        // Mettre à jour le cache dans le navigateur
        localStorage.setItem('geoCache', JSON.stringify(cache));
        alert("Géocodage terminé avec cache mis à jour");
      };

      reader.readAsBinaryString(file);
    });

    async function getOrGeocode(adresse) {
      if (cache[adresse]) return cache[adresse];

      const url = `https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(adresse)}&key=${apiKey}&limit=1&no_annotations=1`;
      const res = await fetch(url);
      const data = await res.json();

      if (data.results.length > 0) {
        const coords = {
          lat: data.results[0].geometry.lat,
          lon: data.results[0].geometry.lng
        };
        cache[adresse] = coords;
        return coords;
      }

      return null;
    }

    function excelDateToJSDate(serial) {
        const utc_days = Math.floor(serial - 25569);
        const utc_value = utc_days * 86400;
        const date_info = new Date(utc_value * 1000);
        return date_info.toLocaleDateString('fr-FR');
    }

    function exportCache() {
      const blob = new Blob([JSON.stringify(cache, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "geo_cache.json";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
